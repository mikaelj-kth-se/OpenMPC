

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Non-linear offset-free MPC &mdash; openmpc 0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=837179f8"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Simple offset-free MPC example" href="offset_free_simple.html" />
    <link rel="prev" title="offset free NMPC" href="Offsetfree_advanced.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/mpc_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#dependencies">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#mosek-license">Mosek License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html#contributing">Contributing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="cessna_descent.html">Cessna aircraft descent</a></li>
<li class="toctree-l2"><a class="reference internal" href="constraint_softening.html">Constraint softening</a></li>
<li class="toctree-l2"><a class="reference internal" href="discretization_notebook.html">Comparison of Discretization Schemes for a Simple Pendulum</a></li>
<li class="toctree-l2"><a class="reference internal" href="double_integrator.html">Double integrator</a></li>
<li class="toctree-l2"><a class="reference internal" href="helicopter.html">Helicopter</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html">Basic Model Predictive Control in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="invariant_sets.html">A few notes on control invariant sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="invariant_sets.html#A-basic-example">A basic example</a></li>
<li class="toctree-l2"><a class="reference internal" href="invariant_sets.html#A-useful-control-invariant-set:-the-invariant-set-of-the-LQR-controller">A useful control invariant set: the invariant set of the LQR controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="invariant_sets.html#The-maximal-control-invariant-set">The maximal control invariant set</a></li>
<li class="toctree-l2"><a class="reference internal" href="invariant_sets.html#The-initial-feasible-set-of-the-MPC-controller">The initial feasible set of the MPC controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiple_shooting_pendulum_swingup.html">Open-loop optimal control of a simple pendulum using multiple-shooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="nonlinear_tracking_heat_exchanger.html">Non-linear Tracking MPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="Offsetfree_advanced.html">offset free NMPC</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Non-linear offset-free MPC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Define-the-model-parameters">Define the model parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-the-System-States-and-Control-Inputs">Define the System States and Control Inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-the-Prediction-Model">Define the Prediction Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-Disturbance-Profiles-and-Desired-Output">Define Disturbance Profiles and Desired Output</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-the-MPC-Controller">Define the MPC Controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-the-Simulation-Model">Define the Simulation Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Define-the-EKF-(Extended-Kalman-Filter)">Define the EKF (Extended Kalman Filter)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Set-Up-Simulation">Set Up Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Run-the-Simulation">Run the Simulation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="offset_free_simple.html">Simple offset-free MPC example</a></li>
<li class="toctree-l2"><a class="reference internal" href="reference_tracking_aircraft.html">Reference tracking NMPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="simpleMPC_invPend.html">Pendulum on Cart System with MPC Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="single_shooting_pendulum_swingup.html">Open-loop optimal control of a simple pendulum using single-shooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="swingup_pendcart_nlmpc.html">Swingup of a pendulum on a cart using nonlinear MPC</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">openmpc</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">openmpc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Non-linear offset-free MPC</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/offset_free_mpc_heat_exchanger.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Non-linear-offset-free-MPC">
<h1>Non-linear offset-free MPC<a class="headerlink" href="#Non-linear-offset-free-MPC" title="Link to this heading"></a></h1>
<p>In this notebook, we will design an offset-free model predictive control (MPC) for a heat exchanger using noisy output measurements. In contrast to the nonlinear tracking MPC controller for the same system, we do no longer assume that we have complete and error-free access to system states and disturbances, or that the prediction model agrees perfectly with the true system dynamics (here represented by a simulation model). Instead, we use an extended Kalman filter to estimate the system states
and disturbances, and we use slightly different model parameters for the simulation model. Nevertheless, as we will see, the resulting controller is able to attain error-free tracking in face of system disturbances.</p>
<section id="Define-the-model-parameters">
<h2>Define the model parameters<a class="headerlink" href="#Define-the-model-parameters" title="Link to this heading"></a></h2>
<p>We begin by defining the model parameters for the heat exchanger.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">casadi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ca</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmpc.NonlinearMPC</span><span class="w"> </span><span class="kn">import</span> <span class="n">NonlinearSystem</span><span class="p">,</span><span class="n">trackingMPC</span><span class="p">,</span> <span class="n">EKF</span><span class="p">,</span> <span class="n">create_estimator_model</span>

<span class="c1"># Define the model parameters</span>
<span class="n">C_hot</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Heat capacity of hot fluid (J/K)</span>
<span class="n">C_cold</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Heat capacity of cold fluid (J/K)</span>
<span class="n">c_p_hot</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Specific heat capacity of hot fluid (J/kg·K)</span>
<span class="n">c_p_cold</span> <span class="o">=</span> <span class="mi">4184</span>  <span class="c1"># Specific heat capacity of cold fluid (J/kg·K)</span>
<span class="n">U</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Overall heat transfer coefficient (W/m²*K)</span>
<span class="n">A</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Heat transfer area (m²)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-System-States-and-Control-Inputs">
<h2>Define the System States and Control Inputs<a class="headerlink" href="#Define-the-System-States-and-Control-Inputs" title="Link to this heading"></a></h2>
<p>We will now define the system states and control inputs.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the system states and control inputs</span>
<span class="n">T_hot</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_hot&#39;</span><span class="p">)</span>
<span class="n">T_hot_in</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_hot_in&#39;</span><span class="p">)</span>
<span class="n">T_cold</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_cold&#39;</span><span class="p">)</span>
<span class="n">T_cold_in</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_cold_in&#39;</span><span class="p">)</span>
<span class="n">m_dot_hot</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;m_dot_hot&#39;</span><span class="p">)</span>
<span class="n">m_dot_cold</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;m_dot_cold&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-Prediction-Model">
<h2>Define the Prediction Model<a class="headerlink" href="#Define-the-Prediction-Model" title="Link to this heading"></a></h2>
<p>Next, we define the prediction model for the heat exchanger.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define prediction model</span>
<span class="n">samplingTime</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">dT_hot</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">C_hot</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m_dot_hot</span> <span class="o">*</span> <span class="n">c_p_hot</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_hot_in</span> <span class="o">-</span> <span class="n">T_hot</span><span class="p">)</span> <span class="o">-</span> <span class="n">U</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_hot</span> <span class="o">-</span> <span class="n">T_cold</span><span class="p">))</span>
<span class="n">dT_cold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">C_cold</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m_dot_cold</span> <span class="o">*</span> <span class="n">c_p_cold</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_cold_in</span> <span class="o">-</span> <span class="n">T_cold</span><span class="p">)</span> <span class="o">+</span> <span class="n">U</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_hot</span> <span class="o">-</span> <span class="n">T_cold</span><span class="p">))</span>

<span class="n">rhs</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">dT_hot</span><span class="p">,</span> <span class="n">dT_cold</span><span class="p">)</span>
<span class="n">states</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">T_hot</span><span class="p">,</span> <span class="n">T_cold</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">m_dot_hot</span><span class="p">,</span> <span class="n">m_dot_cold</span><span class="p">)</span>
<span class="n">disturbances</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">T_hot_in</span><span class="p">,</span> <span class="n">T_cold_in</span><span class="p">)</span>

<span class="c1"># Create the NonlinearSystem object</span>
<span class="n">heatExchangerSystem</span> <span class="o">=</span> <span class="n">NonlinearSystem</span><span class="p">(</span><span class="n">updfcn</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">disturbances</span><span class="o">=</span><span class="n">disturbances</span><span class="p">,</span> <span class="n">outfcn</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>

<span class="c1"># Define discrete-time prediction model</span>
<span class="n">predictionModel</span><span class="o">=</span><span class="n">heatExchangerSystem</span><span class="o">.</span><span class="n">c2d</span><span class="p">(</span><span class="n">samplingTime</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-Disturbance-Profiles-and-Desired-Output">
<h2>Define Disturbance Profiles and Desired Output<a class="headerlink" href="#Define-Disturbance-Profiles-and-Desired-Output" title="Link to this heading"></a></h2>
<p>We define the disturbance profiles and the desired output temperatures for the heat exchanger.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define disturbance profiles</span>
<span class="n">T_hot_in</span> <span class="o">=</span> <span class="mi">150</span>  <span class="c1"># Nominal inlet temperature of hot fluid (°C)</span>
<span class="n">T_cold_in</span> <span class="o">=</span> <span class="mi">25</span>  <span class="c1"># Nominal inlet temperature of cold fluid (°C)</span>

<span class="c1"># Define desired outlet temperatures</span>
<span class="n">T_hot_ref</span> <span class="o">=</span> <span class="mi">110</span>  <span class="c1"># Desired outlet temperature of hot fluid (°C)</span>
<span class="n">T_cold_ref</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Desired outlet temperature of cold fluid (°C)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-MPC-Controller">
<h2>Define the MPC Controller<a class="headerlink" href="#Define-the-MPC-Controller" title="Link to this heading"></a></h2>
<p>Now, we define the MPC controller using the prediction model and other parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Q</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>

<span class="c1"># Compute the LQR controller and the corresponding Riccati solution</span>
<span class="n">dnom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_hot_in</span><span class="p">,</span> <span class="n">T_cold_in</span><span class="p">])</span>
<span class="n">yref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_hot_ref</span><span class="p">,</span> <span class="n">T_cold_ref</span><span class="p">])</span>
<span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">uref</span><span class="p">)</span> <span class="o">=</span> <span class="n">predictionModel</span><span class="o">.</span><span class="n">get_target_point</span><span class="p">(</span><span class="n">yref</span><span class="p">,</span> <span class="n">dnom</span><span class="p">)</span>
<span class="n">L</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">predictionModel</span><span class="o">.</span><span class="n">compute_lqr_controller</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="n">xref</span><span class="p">,</span> <span class="n">uref</span><span class="p">,</span> <span class="n">dnom</span><span class="p">))</span>

<span class="n">mpcProblemData</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">samplingTime</span><span class="p">,</span>  <span class="c1"># sampling time</span>
    <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
    <span class="s1">&#39;Q_N&#39;</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span>
    <span class="s1">&#39;predictionModel&#39;</span><span class="p">:</span> <span class="n">predictionModel</span><span class="p">,</span>
    <span class="s1">&#39;umin&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>  <span class="c1"># Control limits</span>
    <span class="s1">&#39;umax&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]),</span>  <span class="c1"># Control limits</span>
    <span class="s1">&#39;slackPenaltyWeight&#39;</span><span class="p">:</span> <span class="mf">1e6</span><span class="p">,</span>  <span class="c1"># Slack penalty weight</span>
    <span class="s1">&#39;baseController&#39;</span><span class="p">:</span> <span class="n">L</span><span class="p">,</span>
    <span class="s1">&#39;dualModeHorizon&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Dual mode horizon</span>
    <span class="s1">&#39;dualModeController&#39;</span><span class="p">:</span> <span class="n">L</span>
<span class="p">}</span>


<span class="c1"># Initialize the MPC controller</span>
<span class="n">mpc</span> <span class="o">=</span> <span class="n">trackingMPC</span><span class="p">(</span><span class="n">mpcProblemData</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit https://github.com/coin-or/Ipopt
******************************************************************************

</pre></div></div>
</div>
</section>
<section id="Define-the-Simulation-Model">
<h2>Define the Simulation Model<a class="headerlink" href="#Define-the-Simulation-Model" title="Link to this heading"></a></h2>
<p>We define the simulation model for the heat exchanger. Note that in this case, we use slightly different <code class="docutils literal notranslate"><span class="pre">c_p</span></code> values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">createSimulationModel</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the simulation model with system dynamics.</span>

<span class="sd">    Returns:</span>
<span class="sd">    NonlinearSystem: A NonlinearSystem object representing the simulation model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define the system dynamics for the simulation model</span>
    <span class="n">T_hot</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_hot&#39;</span><span class="p">)</span>
    <span class="n">T_cold</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_cold&#39;</span><span class="p">)</span>
    <span class="n">m_dot_hot</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;m_dot_hot&#39;</span><span class="p">)</span>
    <span class="n">m_dot_cold</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;m_dot_cold&#39;</span><span class="p">)</span>
    <span class="n">T_hot_in</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_hot_in&#39;</span><span class="p">)</span>
    <span class="n">T_cold_in</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">MX</span><span class="o">.</span><span class="n">sym</span><span class="p">(</span><span class="s1">&#39;T_cold_in&#39;</span><span class="p">)</span>

    <span class="c1"># Define the model parameters</span>
    <span class="n">C_hot</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Heat capacity of hot fluid (J/K)</span>
    <span class="n">C_cold</span> <span class="o">=</span> <span class="mi">5000</span>  <span class="c1"># Heat capacity of cold fluid (J/K)</span>
    <span class="n">c_p_hot</span> <span class="o">=</span> <span class="mi">2500</span>  <span class="c1"># Specific heat capacity of hot fluid (J/kg·K)</span>
    <span class="n">c_p_cold</span> <span class="o">=</span> <span class="mi">4000</span>  <span class="c1"># Specific heat capacity of cold fluid (J/kg·K)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Overall heat transfer coefficient (W/m²*K)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c1"># Heat transfer area (m²)</span>

    <span class="c1"># Define the system dynamics</span>
    <span class="n">dT_hot</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">C_hot</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m_dot_hot</span> <span class="o">*</span> <span class="n">c_p_hot</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_hot_in</span> <span class="o">-</span> <span class="n">T_hot</span><span class="p">)</span> <span class="o">-</span> <span class="n">U</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_hot</span> <span class="o">-</span> <span class="n">T_cold</span><span class="p">))</span>
    <span class="n">dT_cold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">C_cold</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">m_dot_cold</span> <span class="o">*</span> <span class="n">c_p_cold</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_cold_in</span> <span class="o">-</span> <span class="n">T_cold</span><span class="p">)</span> <span class="o">+</span> <span class="n">U</span> <span class="o">*</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_hot</span> <span class="o">-</span> <span class="n">T_cold</span><span class="p">))</span>

    <span class="n">rhs</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span>
        <span class="n">dT_hot</span><span class="p">,</span>           <span class="c1"># dT_hot/dt</span>
        <span class="n">dT_cold</span>           <span class="c1"># dT_cold/dt</span>
    <span class="p">)</span>

    <span class="c1"># Define state, input, and disturbance vectors</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">T_hot</span><span class="p">,</span> <span class="n">T_cold</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">m_dot_hot</span><span class="p">,</span> <span class="n">m_dot_cold</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">vertcat</span><span class="p">(</span><span class="n">T_hot_in</span><span class="p">,</span> <span class="n">T_cold_in</span><span class="p">)</span>

    <span class="c1"># Create the NonlinearSystem object</span>
    <span class="n">simulationModel</span> <span class="o">=</span> <span class="n">NonlinearSystem</span><span class="p">(</span><span class="n">updfcn</span><span class="o">=</span><span class="n">rhs</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">disturbances</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">simulationModel</span>

<span class="c1"># Create the simulation model</span>
<span class="n">simulationModel</span> <span class="o">=</span> <span class="n">createSimulationModel</span><span class="p">()</span><span class="o">.</span><span class="n">c2d</span><span class="p">(</span><span class="n">samplingTime</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Define-the-EKF-(Extended-Kalman-Filter)">
<h2>Define the EKF (Extended Kalman Filter)<a class="headerlink" href="#Define-the-EKF-(Extended-Kalman-Filter)" title="Link to this heading"></a></h2>
<p>We define the EKF for state and disturbance estimation using the prediction model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimatorModel</span><span class="o">=</span><span class="n">create_estimator_model</span><span class="p">(</span><span class="n">predictionModel</span><span class="p">)</span>

<span class="c1"># Define the initial state and covariance estimates</span>
<span class="n">xe0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">120</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>  <span class="c1"># Initial state [T_hot, T_cold, T_hot_in, T_cold_in]</span>
<span class="n">P0</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># Initial state covariance</span>

<span class="c1"># Define the process noise and measurement noise covariance matrices</span>
<span class="n">Qnoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">])</span>  <span class="c1"># Process noise covariance</span>
<span class="n">Rnoise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>  <span class="c1"># Measurement noise covariance</span>

<span class="c1"># Pack the EKF parameters into a struct</span>
<span class="n">ekfParameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;predictionModel&#39;</span><span class="p">:</span> <span class="n">estimatorModel</span><span class="p">,</span>
    <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">Qnoise</span><span class="p">,</span>
    <span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">Rnoise</span><span class="p">,</span>
    <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">xe0</span><span class="p">,</span>
    <span class="s1">&#39;P0&#39;</span><span class="p">:</span> <span class="n">P0</span><span class="p">,</span>
    <span class="s1">&#39;dt&#39;</span><span class="p">:</span> <span class="n">samplingTime</span>  <span class="c1"># Time step</span>
<span class="p">}</span>
<span class="n">ekf</span> <span class="o">=</span> <span class="n">EKF</span><span class="p">(</span><span class="n">ekfParameters</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
@1=vertcat(T_hot, T_cold), @2=vertcat((0.0002*(((2000*m_dot_hot)*(T_hot_in-T_hot))-(25000*(T_hot-T_cold)))), (0.0002*(((4184*m_dot_cold)*(T_cold_in-T_cold))+(25000*(T_hot-T_cold))))), @3=vertcat(m_dot_hot, m_dot_cold), @4=vertcat(T_hot_in, T_cold_in), @5=updfcn((@1+(0.05*@2)), @3, @4){0}, @6=updfcn((@1+(0.05*@5)), @3, @4){0}, vertcat((@1+(0.0166667*(((@2+(2.*@5))+(2.*@6))+updfcn((@1+(0.1*@6)), @3, @4){0}))), T_hot_in, T_cold_in)
vertcat(T_hot, T_cold)
</pre></div></div>
</div>
</section>
<section id="Set-Up-Simulation">
<h2>Set Up Simulation<a class="headerlink" href="#Set-Up-Simulation" title="Link to this heading"></a></h2>
<p>We will now set up the simulation environment and initialize the state and control trajectories for the simulation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the time step</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">samplingTime</span>  <span class="c1"># Time step (hours)</span>

<span class="c1"># Create the Runge-Kutta integrator for the simulation model</span>
<span class="c1">#sim_integrator = RK(simulationModel, dt, order=4)</span>

<span class="c1"># Simulation time</span>
<span class="n">Tsim</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Final time (hours)</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Tsim</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="c1"># Define the initial conditions</span>
<span class="n">T_hot_0</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># Initial temperature of hot fluid (°C)</span>
<span class="n">T_cold_0</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># Initial temperature of cold fluid (°C)</span>
<br/><br/></pre></div>
</div>
</div>
</section>
<section id="Run-the-Simulation">
<h2>Run the Simulation<a class="headerlink" href="#Run-the-Simulation" title="Link to this heading"></a></h2>
<p>We run the simulation loop, update the EKF with the new measurements, and compute the control actions using the MPC.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial state</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_hot_ref</span><span class="p">,</span> <span class="n">T_cold_ref</span><span class="p">])</span>
<span class="n">yref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_hot_ref</span><span class="p">,</span> <span class="n">T_cold_ref</span><span class="p">])</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_hot_in</span><span class="p">,</span> <span class="n">T_cold_in</span><span class="p">])</span>

<span class="c1"># Initialize state and control trajectories for simulation</span>
<span class="n">x_sim</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
<span class="n">u_sim</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">x_hat</span> <span class="o">=</span> <span class="n">xe0</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
    <span class="n">x_current</span> <span class="o">=</span> <span class="n">x_sim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x_hat</span> <span class="o">=</span> <span class="n">ekf</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_cold_in</span> <span class="o">+</span> <span class="mi">5</span>

    <span class="k">if</span> <span class="n">time</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">yref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_hot_ref</span> <span class="o">-</span> <span class="mi">10</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">u_current</span> <span class="o">=</span> <span class="n">mpc</span><span class="o">.</span><span class="n">get_control_action</span><span class="p">(</span><span class="n">x_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">],</span> <span class="n">yref</span><span class="p">,</span> <span class="n">x_hat</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error at simulation step </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="c1"># Integrate the state using the simulation model</span>
    <span class="n">x_next</span> <span class="o">=</span> <span class="n">simulationModel</span><span class="o">.</span><span class="n">updfcn</span><span class="p">(</span><span class="n">x_current</span><span class="p">,</span> <span class="n">u_current</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">full</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Simulate a measurement</span>
    <span class="n">y_meas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_next</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_next</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ekf</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>

    <span class="c1"># Update the EKF with the new measurement</span>
    <span class="n">ekf</span><span class="o">.</span><span class="n">prediction_update</span><span class="p">(</span><span class="n">u_current</span><span class="p">)</span>
    <span class="n">ekf</span><span class="o">.</span><span class="n">measurement_update</span><span class="p">(</span><span class="n">y_meas</span><span class="p">,</span> <span class="n">u_current</span><span class="p">)</span>

    <span class="c1"># Store the control action and the next state</span>
    <span class="n">u_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u_current</span><span class="p">)</span>
    <span class="n">x_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_next</span><span class="p">)</span>

    <span class="c1"># Print status every hour of simulation time</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sim_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulation time: </span><span class="si">{</span><span class="n">sim_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> hours. Current system state: </span><span class="si">{</span><span class="n">x_next</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Convert simulation results to numpy arrays for easier manipulation</span>
<span class="n">x_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_sim</span><span class="p">)</span>
<span class="n">u_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_sim</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Simulation time: 1.00 hours. Current system state: [110.17224244  50.02906914]
Simulation time: 2.00 hours. Current system state: [110.01331547  50.00166641]
Simulation time: 3.00 hours. Current system state: [109.96446047  50.01649322]
Simulation time: 4.00 hours. Current system state: [109.99913317  50.05880732]
Simulation time: 5.00 hours. Current system state: [109.99202336  49.99214992]
Simulation time: 6.00 hours. Current system state: [110.03198341  50.59244892]
Simulation time: 7.00 hours. Current system state: [109.94847226  50.10008488]
Simulation time: 8.00 hours. Current system state: [109.9646889   50.00069371]
Simulation time: 9.00 hours. Current system state: [109.988744    49.95610458]
Simulation time: 10.00 hours. Current system state: [110.05735529  50.07209061]
Simulation time: 11.00 hours. Current system state: [100.4384037   49.90931593]
Simulation time: 12.00 hours. Current system state: [100.14601551  49.92607188]
Simulation time: 13.00 hours. Current system state: [100.02487704  49.94206819]
Simulation time: 14.00 hours. Current system state: [100.01024749  49.95991919]
Simulation time: 15.00 hours. Current system state: [100.00613498  49.99761133]
Simulation time: 16.00 hours. Current system state: [100.024779   50.0847383]
Simulation time: 17.00 hours. Current system state: [100.00963057  50.06044886]
Simulation time: 18.00 hours. Current system state: [100.04081277  50.07805643]
Simulation time: 19.00 hours. Current system state: [100.0327923   49.98094954]
Simulation time: 20.00 hours. Current system state: [100.02008386  50.05581151]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Ensure the simulation result arrays are numpy arrays for easier manipulation</span>
<span class="n">x_sim_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_sim</span><span class="p">)</span>
<span class="n">u_sim_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_sim</span><span class="p">)</span>

<span class="c1"># Time grid for plotting</span>
<span class="n">t_sim</span> <span class="o">=</span> <span class="n">time</span>

<span class="c1"># Create the figure and subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot the state trajectories on the first subplot</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">x_sim_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Hot Fluid Temperature&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#AA3939&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">x_sim_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cold Fluid Temperature&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#004791&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Update reference values to reflect the change at T = 10</span>
<span class="n">T_hot_ref_updated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">T_hot_ref</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="n">T_hot_ref</span><span class="o">-</span><span class="mi">10</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_sim</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">T_hot_ref_updated</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#AA3939&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference Hot Temperature&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">T_cold_ref</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#004791&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference Cold Temperature&#39;</span><span class="p">)</span>

<span class="c1"># Set x-limits</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">Tsim</span><span class="p">])</span>

<span class="c1"># Set labels, title, and legend</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [hours]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature [°C]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Temperature Trajectories&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot the control trajectories on the second subplot</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">u_sim_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Hot Fluid Flow Rate&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#AA3939&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_sim</span><span class="p">,</span> <span class="n">u_sim_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cold Fluid Flow Rate&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#004791&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Set x-limits</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">Tsim</span><span class="p">])</span>

<span class="c1"># Set labels, title, and legend</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [hours]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flow Rate [kg/s]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Flow Rate Trajectories&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Adjust layout and save the figure as a PDF</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;heat_exchanger_simulation.pdf&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>

<span class="c1"># Display the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_offset_free_mpc_heat_exchanger_18_0.png" src="../_images/examples_offset_free_mpc_heat_exchanger_18_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Offsetfree_advanced.html" class="btn btn-neutral float-left" title="offset free NMPC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="offset_free_simple.html" class="btn btn-neutral float-right" title="Simple offset-free MPC example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mikael Johansson, Pedro Roque and Gregorio Marchesini.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>